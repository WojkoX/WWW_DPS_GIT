<hr>
<h3 class="mb-4">
   <b>{{ resident.last_name }} {{ resident.first_name }} </b>    [PokÃ³j {{ resident.room_number }} - PiÄ™tro {{ resident.floor }}]
  
    <a href="{{ url_for('residents.edit_resident', resident_id=resident.id) }}"
       class="btn btn-sm btn-outline-primary float-end"
       onclick="return confirm('Opuscic formatkÄ™ i przejÅ›c do edycji mieszkaÅ„ca?');">
        Edytuj dane mieszkaÅ„ca
      </a>
  


</h3>

<script>
function validateDietForm(form, event) {
    // 1. SprawdÅº czy klikniÄ™to przycisk "Odepnij"
    // Szukamy przycisku, ktÃ³ry wywoÅ‚aÅ‚ zdarzenie (obsÅ‚uga starszych i nowszych przeglÄ…darek)
    const btn = event.submitter;
    
    if (btn && btn.getAttribute('formaction') && btn.getAttribute('formaction').includes('detach_diet')) {
        return true; // PozwÃ³l odpiÄ…Ä‡ dietÄ™ bez walidacji
    }

    // 2. ZnajdÅº select wewnÄ…trz TYLKO TEGO formularza (dziÄ™ki przekazanemu 'form')
    const select = form.querySelector('select[name="diet_id"]');
    
    if (!select.value || select.value === "") {
        event.preventDefault(); // Zablokuj wysyÅ‚kÄ™
        alert("â— ProszÄ™ wybraÄ‡ dietÄ™ przed zapisaniem.");
        select.classList.add('is-invalid');
        select.focus();
        return false;
    }

    return true;
}
</script>

<form id="dietForm" method="post"
      action="{{ url_for('residents.save_diet', resident_id=resident.id) }}" onsubmit="return validateDietForm(this, event)">

  <!-- DIETA -->
  <div class="mb-3">
    <label class="form-label fw-bold">Dieta</label>
    <select name="diet_id" class="form-select" required>
      <option value="">-- wybierz dietÄ™ --</option>
      {% for d in diets %}
        <option value="{{ d.id }}"
          {% if diet and diet.diet_id == d.id %}selected{% endif %}>
          {{ d.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- POSIÅKI -->
  <div class="mb-3">
    <label class="form-label fw-bold">PosiÅ‚ki jedzone w pokoju</label>

    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="breakfast"
        {% if diet and diet.breakfast %}checked{% endif %}>
      <label class="form-check-label">Åšniadanie</label>
    </div>

    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="lunch"
        {% if diet and diet.lunch %}checked{% endif %}>
      <label class="form-check-label">Obiad</label>
    </div>

    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="dinner"
        {% if diet and diet.dinner %}checked{% endif %}>
      <label class="form-check-label">Kolacja</label>
    </div>
  </div>

  <!-- UWAGI -->
  <div class="mb-3">
    <label class="form-label fw-bold">Uwagi dla kuchni <= (Mieszkaniec:Uwagi)</label>
    <textarea name="notes" class="form-control" rows="2" autocomplete="off">{{ resident.notes or '' }}</textarea>
  </div>

  <!-- AKCJE -->
  <div class="d-flex justify-content-between align-items-center mt-4">

    <!-- LEWA STRONA -->
    <div class="d-flex gap-2">
      <button type="submit"   id="submitDiet" class="btn btn-success">
        ğŸ’¾ Przypisz dietÄ™ mieszkaÅ„cowi
      </button>

      <a href="{{ url_for('dashboard.dashboard') }}"
         class="btn btn-outline-secondary">
        Anuluj
      </a>
    </div>

    <!-- PRAWA STRONA -->
    {% if resident.has_diet %}
      <button type="submit"
              class="btn btn-outline-danger"
              formaction="{{ url_for('residents.detach_diet', resident_id=resident.id) }}"
              onclick="return confirm('Czy na pewno odpiÄ…Ä‡ dietÄ™?');" formnovalidate>
        Odepnij dietÄ™
      </button>
    {% endif %}

  </div>
</form>